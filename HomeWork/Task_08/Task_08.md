# Настройка PostgreSQL. 

Занятие от 13.05.2024

## Выполнение домашнего задания:

 - развернуть виртуальную машину любым удобным способом
 - поставить на неё PostgreSQL 15 любым способом
 - настроить кластер PostgreSQL 15 на максимальную производительность не обращая внимание на возможные проблемы с надежностью в случае аварийной перезагрузки виртуальной машины
 - нагрузить кластер через утилиту через утилиту pgbench (https://postgrespro.ru/docs/postgrespro/14/pgbench)
 - написать какого значения tps удалось достичь, показать какие параметры в какие значения устанавливали и почему
 - Задание со *: аналогично протестировать через утилиту https://github.com/Percona-Lab/sysbench-tpcc (требует установки
https://github.com/akopytov/sysbench)

### Комменатрий:

Для опеределения параметров, которые стоит изменить, воспользовался сайтом https://pgconfigurator.cybertec.at/. Часть параметров из рекомендаций не применял, так как прироста в TPS не было.

Параметры ВМ: 2 CPU, 4 RAM, SSD.

Для тестирования использовал команду с параметрами - ***pgbench -c 10 -T 300 -U postgres postgres***\
При значениях по умолчанию - tps = 997.551954\
После внесения изменений - tps = 2844.606357

Изменяемые параметры:

***shared_buffers = 1Gb***\
Параметр **shared_buffers** определяет , сколько памяти выделено серверу для кэширования данных. Рекомендуемое значение в пределах от 15% до 25% от общего объема оперативной памяти компьютера.

***work_mem = 32MB***\
Параметр **work_mem** в основном определяет объем памяти, который будет использоваться внутренними операциями сортировки и хеш-таблицами перед записью во временные файлы на диске. Операции сортировки используются для операций упорядочивания, разделения и объединения слиянием. Хэш-таблицы используются в хэш-соединениях и агрегации на основе хеша. Установка правильного значения параметра **work_mem** может привести к меньшему количеству подкачки дисков и, следовательно, к более быстрому выполнению запросов. 

***maintenance_work_mem = 320MB***\
Устанавливает базовый максимальный объем памяти, который будет использоваться операцией запроса (например, сортировкой или хэш-таблицей) перед записью во временные файлы на диске.

***effective_cache_size = 3GB***\
Этот параметр позволяет PostgreSQL лучше использовать доступную память, что уменьшает количество необходимых операций чтения с диска и повышает производительность запросов.


***effective_io_concurrency = 100***\
Задаёт допустимое число параллельных операций ввода/вывода, которое говорит PostgreSQL о том, сколько операций ввода/вывода могут быть выполнены одновременно. Чем больше это число, тем больше операций ввода/вывода будет пытаться выполнить параллельно PostgreSQL в отдельном сеансе. 

***random_page_cost = 1.25***\
Данный параметр влияет на план запроса. Значение random_page_cost по умолчанию - 4.0. Уменьшение параметра приведёт к тому, что при выполении запроса будет сканироваться не таблица, а подходящий индекс.

***checkpoint_timeout = '15 min'***\
Контрольные точки довольно дороги, во-первых, потому что они требуют записи всех грязных в данный момент буферов, а во-вторых, потому что они приводят к дополнительному последующему трафику WAL. Поэтому разумно установить достаточно высокие параметры контрольных точек, чтобы контрольные точки не возникали слишком часто.

***synchronous_commit = off***\
По умолчанию PostgreSQL обеспечивает согласованность. Это контролируется параметром сервера synchronous_commit. Параметр указывает, будет ли фиксация транзакции ожидать записи записей WAL на диск, прежде чем команда вернет клиенту сообщение об успехе. 