# Логический уровень PostgreSQL 

Занятие от 22.04.2024

## Выполнение домашнего задания:

 - создайте новую базу данных testd
 - зайдите в созданную базу данных под пользователем postgres
 - создайте новую схему testnm
 - создайте новую таблицу t1 с одной колонкой c1 типа integer
 - вставьте строку со значением c1=1
 - создайте новую роль readonly
 - дайте новой роли право на подключение к базе данных testdb
 - дайте новой роли право на использование схемы testnm
 - дайте новой роли право на select для всех таблиц схемы testnm
 - создайте пользователя testread с паролем test123
 - дайте роль readonly пользователю testread
 - зайдите под пользователем testread в базу данных testdb
 - сделайте select * from t1;
 - получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже)
 
 Ответ: не получилось.

 - напишите что именно произошло в тексте домашнего задания

Ответ: *ERROR: permission denied for table t1*.

 - у вас есть идеи почему? ведь права то дали?

Ответ: таблица **t1** была создана в cхеме по умолчанию - **public**. Права для роли **readonly** выдавали на схему **testnm**.

 - посмотрите на список таблиц
 - подсказка в шпаргалке под пунктом 20
 - а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)

Ответ: при создании таблицы **t1** явно не указывалась схема, поэтому схема бралась из параметра **search_path**, в котором указаны значения **"$user", public**. Так как нет схемы с названием **testread**, то таблица была создана в схеме **public**.

Вывод списка схем в базе **testdb**:\
***schema_name***\
***--------------------***\
***testnm***\
***information_schema***\
***pg_catalog***\
***pg_toast***\
***public***\
***(5 rows)***

 - вернитесь в базу данных testdb под пользователем postgres
 - удалите таблицу t1
 - создайте ее заново но уже с явным указанием имени схемы testnmcre    
 - вставьте строку со значением c1=1
 - зайдите под пользователем testread в базу данных testdb
 - сделайте select * from testnm.t1;
 - получилось?

Ответ: *ERROR:  permission denied for table t1*.

 - есть идеи почему? если нет - смотрите шпаргалку

Ответ: инструкция ***GRANT SELECT ON ALL TABLES IN SCHEMA***, которую делали ранее, предоставляет права только на те таблицы, которые уже были созданы на момент предоставления прав.

 - как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку

Ответ: инструкция *ALTER DEFAULT PRIVILEGES* позволяет задавать права, применяемые к объектам, которые будут создаваться в будущем. Необходимо выполнить запрос ниже:\
*ALTER DEFAULT PRIVILEGES IN SCHEMA testnm GRANT SELECT ON TABLES TO readonly;*

 - сделайте select * from testnm.t1;
 - получилось?

Ответ: *ERROR:  permission denied for table t1*.

 - есть идеи почему? если нет - смотрите шпаргалку

Ответ: необходимо повторно выдать разрешение на *SELECT* на все таблицы схемы **testnm** для роли **readonly**.

 - сделайте select * from testnm.t1;
 - получилось?

Ответ: данные из таблицы вывелись без ошибки. Дополнительно пересоздал таблицу **testnm.t1** и выполнил *SELECT* - данные вывелись.

 - ура!
 - теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);
 - а как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?

Ответ: так как нет схемы с названием **testread**, то таблица создаётся в схеме **public**. Каждый пользователь может по умолчанию создавать объекты в схеме public любой базы данных.

 - есть идеи как убрать эти права? если нет - смотрите шпаргалку
 
 Ответ:\
***REVOKE CREATE on SCHEMA public FROM public;***\
***REVOKE ALL on DATABASE testdb FROM public;***\

 - если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды

Ответ: ко всем пользователям применяется роль **public**, которая имеет права *CREATE* на схему public в во всех базах данных. Поэтому отзываем права *CREATE* у роли **public** для схемы **public**. Также необходимо отозвать все права у роли **public** для базы **testdb**.

 - теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);

Ответ:\
***testdb=> create table t3(c1 integer);***\
***ERROR:  permission denied for schema public***\
***LINE 1: create table t3(c1 integer);***\
***testdb=> insert into t2 values (2);***\
***INSERT 0 1***

 - расскажите что получилось и почему

 Ответ: в таблицу **t2** удалось вставить данные, так как пользователь **testread** является владельцем таблицы и имеет в ней полные права. Создать таблицу под пользователем **testread** нельзя, так как отозвали права *CREATE* для роли **public**.